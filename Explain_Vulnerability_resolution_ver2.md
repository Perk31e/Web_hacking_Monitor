# 반려동물 커뮤니티 웹 애플리케이션 보안 취약점 분석 및 대응 가이드

## 📋 개요
이 문서는 교육 목적으로 제작된 반려동물 커뮤니티 웹 애플리케이션의 보안 취약점과 대응 방법을 설명합니다.

---

## 🔴 주요 취약점

### 1. SQL Injection 취약점

#### 📍 위치
- `UserController.java` - 모든 SQL 쿼리
- `PostController.java` - 모든 SQL 쿼리 (게시글, 댓글, 대댓글 포함)

#### 🔍 취약한 코드 예시
```java
// 로그인 쿼리 (UserController)
String sql = "SELECT * FROM users WHERE email = '" + email + "' AND password = '" + password + "'";

// 댓글 작성 쿼리 (PostController)
String sql = "INSERT INTO comments (content, post_id, user_id, created_at) " +
            "VALUES ('" + content + "', " + postId + ", " + user.getId() + ", NOW())";

// 회원 검색 쿼리 (관리자 기능)
String sql = "SELECT * FROM users WHERE name LIKE '%" + search + "%' OR email LIKE '%" + search + "%'";
```

#### 💥 공격 시나리오

**1) 로그인 우회**
```
이메일: admin@petcommunity.com' OR '1'='1' --
비밀번호: 아무거나
```

**2) 댓글을 통한 데이터 조작**
```
댓글 내용: test'), (SELECT password FROM users WHERE id=1), 1, 1, NOW()); --
```

**3) 관리자 검색을 통한 정보 탈취**
```
검색어: %' UNION SELECT id,password,email,role,NOW(),NOW() FROM users WHERE '1'='1
```

#### ✅ 수정 방법
```java
// PreparedStatement 사용
String sql = "SELECT * FROM users WHERE email = ? AND password = ?";
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setString(1, email);
pstmt.setString(2, password);
ResultSet rs = pstmt.executeQuery();
```

---

### 2. 파일 업로드 취약점

#### 📍 위치
- `PostController.createPost()` 메소드
- `post_form.html` 파일 업로드 폼

#### 🔍 취약한 설정
```java
// 1. 파일 확장자 검증 없음
String originalFilename = file.getOriginalFilename();
String fileExtension = originalFilename.substring(originalFilename.lastIndexOf("."));

// 2. 웹 접근 가능한 경로에 저장
private static final String UPLOAD_DIR = "src/main/resources/static/uploads/";

// 3. 파일 크기 제한이 너무 큼 (application.yml)
max-file-size: 100MB

// 4. 모든 파일 타입 허용 (HTML)
<input type="file" name="image"> <!-- accept 속성 없음 -->
```

#### 💥 공격 시나리오

**1) 웹쉘 업로드**
```
파일명: shell.jsp
내용:
<%
String cmd = request.getParameter("cmd");
Process p = Runtime.getRuntime().exec(cmd);
// ... 웹쉘 코드
%>
```

**2) PHP 웹쉘 (Apache + PHP 환경)**
```
파일명: shell.php
내용:
<?php
if(isset($_GET['cmd'])) {
    echo shell_exec($_GET['cmd']);
}
?>
```

**3) 악성 스크립트 업로드**
```
파일명: malicious.js
내용: 악성 JavaScript 코드
접근: http://localhost:8080/uploads/malicious.js
```

**4) MIME 타입 우회**
- Content-Type 헤더 조작
- 이중 확장자 사용 (file.jpg.php)
- Null byte 삽입 (file.php%00.jpg)

#### ✅ 수정 방법

**1) 확장자 화이트리스트 검증**
```java
private static final Set<String> ALLOWED_EXTENSIONS = 
    Set.of(".jpg", ".jpeg", ".png", ".gif", ".pdf", ".txt");

public boolean isAllowedFile(String filename) {
    String extension = filename.toLowerCase()
        .substring(filename.lastIndexOf("."));
    return ALLOWED_EXTENSIONS.contains(extension);
}
```

**2) MIME 타입 검증**
```java
private static final Set<String> ALLOWED_MIME_TYPES = 
    Set.of("image/jpeg", "image/png", "image/gif", "application/pdf");

public boolean isValidMimeType(MultipartFile file) {
    return ALLOWED_MIME_TYPES.contains(file.getContentType());
}
```

**3) 파일 저장 위치 변경**
```java
// 웹 루트 외부 디렉토리 사용
private static final String UPLOAD_DIR = "/var/uploads/petcommunity/";

// 별도 다운로드 컨트롤러 구현
@GetMapping("/file/{filename}")
public ResponseEntity<Resource> downloadFile(@PathVariable String filename) {
    // 파일 검증 후 안전하게 다운로드 제공
}
```

**4) 파일명 완전 변경**
```java
// 원본 파일명 사용 금지
String newFilename = UUID.randomUUID().toString();
// 확장자도 데이터베이스에 별도 저장
```

---

### 3. 댓글/대댓글 시스템의 추가 취약점

#### 🔍 새로 추가된 기능의 취약점

**1) 댓글 작성 SQL Injection**
```java
// 취약한 코드
String sql = "INSERT INTO comments (content, post_id, user_id, parent_comment_id, created_at) " +
     "VALUES ('" + content + "', " + postId + ", " + user.getId() + 
     ", " + parentCommentId + ", NOW())";
```

**2) XSS 취약점**
- 댓글 내용이 그대로 출력됨
- HTML 태그 필터링 없음

#### 💥 공격 예시

**1) 댓글을 통한 XSS**
```html
댓글 내용: <script>alert('XSS')</script>
또는: <img src=x onerror=alert('XSS')>
```

**2) 댓글을 통한 SQL Injection**
```
댓글 내용: test'), (1, 1, 1, NULL, NOW()); DELETE FROM posts; --
```

#### ✅ 수정 방법

**1) XSS 방지**
```java
// HTML 이스케이프 처리
public String escapeHtml(String input) {
    return input.replace("<", "&lt;")
               .replace(">", "&gt;")
               .replace("\"", "&quot;")
               .replace("'", "&#x27;");
}
```

**2) Thymeleaf 설정**
```html
<!-- 자동 이스케이프 -->
<p th:text="${comment.content}">댓글 내용</p>
<!-- 수동 이스케이프 해제 금지 -->
<!-- <p th:utext="${comment.content}">댓글 내용</p> -->
```

---

### 4. 세션 관리 취약점

#### 🔍 문제점
- 세션 하이재킹 방지 메커니즘 없음
- 세션 만료 시간 설정 없음
- HTTPS 강제 설정 없음

#### ✅ 수정 방법
```yaml
# application.yml
server:
  servlet:
    session:
      timeout: 30m
      cookie:
        secure: true
        http-only: true
        same-site: strict
```

---

### 5. CSRF 취약점

#### 🔍 문제점
- CSRF 토큰 없음
- 중요한 작업에 대한 추가 인증 없음

#### ✅ 수정 방법
```html
<!-- CSRF 토큰 추가 -->
<form method="post" action="/posts">
    <input type="hidden" name="_token" th:value="${_csrf.token}">
    <!-- 폼 내용 -->
</form>
```

---

## 🧪 취약점 테스트 방법

### SQL Injection 테스트

**1) 로그인 우회 테스트**
```
URL: http://localhost:8080/login
이메일: admin@petcommunity.com' OR '1'='1' --
비밀번호: anything
```

**2) 관리자 검색 테스트**
```
URL: http://localhost:8080/admin/users?search=
검색어: %' UNION SELECT 1,password,email,role,NOW(),NOW() FROM users--
```

### 파일 업로드 테스트

**1) 웹쉘 업로드 테스트**
```
1. 게시글 작성 페이지 접속
2. test.jsp 파일 업로드
3. http://localhost:8080/uploads/UUID.jsp 접근 시도
```

**2) 스크립트 파일 업로드**
```
1. malicious.js 파일 업로드
2. http://localhost:8080/uploads/UUID.js 직접 접근
```

---

## 🛠️ 전체적인 보안 강화 방안

### 1. Spring Security 도입
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

### 2. 데이터베이스 설정
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/pet_community?useSSL=true&requireSSL=true
  jpa:
    show-sql: false  # 운영환경에서는 false
```

### 3. 로깅 및 모니터링
```java
@Component
public class SecurityAuditLogger {
    public void logSuspiciousActivity(String activity, String userInfo) {
        logger.warn("Suspicious activity detected: {} from {}", activity, userInfo);
    }
}
```

### 4. 입력 검증 및 정규화
```java
@Valid
public class PostRequest {
    @NotBlank
    @Size(max = 200)
    private String title;
    
    @NotBlank
    @Size(max = 5000)
    private String content;
}
```

---

## ⚠️ 주의사항

**이 애플리케이션은 교육 목적으로만 사용되어야 합니다.**

- 실제 운영 환경에서 사용 금지
- 취약점 테스트는 허가된 환경에서만 수행
- 악의적인 목적으로 사용 금지
- 학습 후 반드시 보안 강화 버전으로 재구현 권장

---

## 📚 참고 자료

1. OWASP Top 10
2. Spring Security Documentation
3. SQL Injection Prevention Cheat Sheet
4. File Upload Security Guidelines
5. XSS Prevention Cheat Sheet

---

**문서 버전:** 2.0  
**최종 업데이트:** 2024년 교육용 버전  
**작성자:** 보안 교육팀